<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout :: layout(~{::section})}"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Usuarios - Admin</title>
  </head>
  <body>
    <section>
      <!-- Contenedor principal -->
      <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
        <div class="max-w-7xl mx-auto px-4 py-8">
          <!-- Mensajes -->
          <div th:if="${error}" id="mensajeError" class="mb-8">
            <div
              class="bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-3xl p-6 shadow-sm"
            >
              <div class="flex items-center">
                <div
                  class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center mr-4"
                >
                  <svg
                    class="w-6 h-6 text-red-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                    />
                  </svg>
                </div>
                <p
                  class="text-base font-medium text-red-800"
                  th:text="${error}"
                ></p>
              </div>
            </div>
          </div>

          <div th:if="${success}" id="mensajeSuccess" class="mb-8">
            <div
              class="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-3xl p-6 shadow-sm"
            >
              <div class="flex items-center">
                <div
                  class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center mr-4"
                >
                  <svg
                    class="w-6 h-6 text-emerald-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                </div>
                <p
                  class="text-base font-medium text-emerald-800"
                  th:text="${success}"
                ></p>
              </div>
            </div>
          </div>

          <!-- Encabezado -->
          <div
            class="bg-white/90 backdrop-blur-sm rounded-3xl border border-gray-200 p-8 shadow-sm mb-8"
          >
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center">
                <div
                  class="w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl flex items-center justify-center mr-6"
                >
                  <svg
                    class="w-8 h-8 text-indigo-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                    />
                  </svg>
                </div>
                <div>
                  <h1
                    class="text-3xl font-bold text-gray-900 mb-2"
                    th:text="${titulo}"
                  >
                    Gestión de Usuarios
                  </h1>
                  <p class="text-lg text-gray-600" th:text="${subtitulo}">
                    Administración de usuarios del sistema
                  </p>
                </div>
              </div>
              <a
                href="/admin/usuarios/nuevo"
                class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 text-sm font-medium shadow-sm flex items-center group"
              >
                <svg
                  class="w-5 h-5 mr-2 group-hover:scale-110 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                Nuevo Usuario
              </a>
            </div>

            <!-- Estadísticas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div
                class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-6"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-blue-600 mb-1">
                      Total Usuarios
                    </p>
                    <p
                      class="text-2xl font-bold text-blue-900"
                      th:text="${totalUsuarios}"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-blue-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-6"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-green-600 mb-1">
                      Activos
                    </p>
                    <p
                      class="text-2xl font-bold text-green-900"
                      th:text="${usuariosActivos}"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-green-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-6"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-amber-600 mb-1">
                      Inactivos
                    </p>
                    <p
                      class="text-2xl font-bold text-amber-900"
                      th:text="${usuariosInactivos}"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-amber-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-red-50 to-pink-50 border border-red-200 rounded-2xl p-6"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-semibold text-red-600 mb-1">
                      Bloqueados
                    </p>
                    <p
                      class="text-2xl font-bold text-red-900"
                      th:text="${usuariosBloqueados}"
                    >
                      0
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center"
                  >
                    <svg
                      class="w-6 h-6 text-red-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="1.5"
                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"
                      />
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filtros -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <form
                th:action="@{/admin/usuarios}"
                method="get"
                class="flex flex-col md:flex-row gap-4 flex-1"
              >
                <div class="flex-1">
                  <input
                    type="text"
                    name="busqueda"
                    th:value="${busqueda}"
                    placeholder="Buscar por nombre, email o usuario..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                  />
                </div>
                <div class="md:w-48">
                  <select
                    name="estado"
                    class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                  >
                    <option value="">Todos los estados</option>
                    <option
                      th:each="estado : ${estados}"
                      th:value="${estado}"
                      th:text="${estado}"
                      th:selected="${estado == estadoFiltro}"
                    >
                      Activo
                    </option>
                  </select>
                </div>
                <button
                  type="submit"
                  class="px-6 py-3 bg-gray-600 text-white rounded-2xl hover:bg-gray-700 transition-colors duration-200 text-sm font-medium"
                >
                  Filtrar
                </button>
                <a
                  href="/admin/usuarios"
                  class="px-6 py-3 bg-gray-100 text-gray-700 rounded-2xl hover:bg-gray-200 transition-colors duration-200 text-sm font-medium text-center"
                >
                  Limpiar
                </a>
              </form>
            </div>
          </div>

          <!-- Tabla de usuarios -->
          <div
            class="bg-white/90 backdrop-blur-sm rounded-3xl border border-gray-200 shadow-sm overflow-hidden"
          >
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Usuario
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Email
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Roles
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Estado
                    </th>
                    <th
                      class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Fecha Registro
                    </th>
                    <th
                      class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider"
                    >
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <tr
                    th:each="usuario : ${usuarios}"
                    class="hover:bg-gray-50 transition-colors duration-200"
                  >
                    <td class="px-6 py-4">
                      <div class="flex items-center">
                        <div
                          class="w-10 h-10 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-xl flex items-center justify-center mr-4"
                        >
                          <svg
                            class="w-5 h-5 text-indigo-600"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="1.5"
                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            />
                          </svg>
                        </div>
                        <div>
                          <p
                            class="text-sm font-semibold text-gray-900"
                            th:text="${usuario.nombreCompleto}"
                          >
                            Nombre Completo
                          </p>
                          <p
                            class="text-sm text-gray-500"
                            th:text="${usuario.nombreUsuario}"
                          >
                            @usuario
                          </p>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <p
                        class="text-sm text-gray-900"
                        th:text="${usuario.email}"
                      >
                        email@ejemplo.com
                      </p>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex flex-wrap gap-1">
                        <span
                          th:each="userRole : ${usuario.roles}"
                          th:if="${userRole.estado.name() == 'Activo'}"
                          class="px-2 py-1 text-xs font-medium rounded-full"
                          th:classappend="${userRole.rol.nombreRol == 'ADMINISTRADOR' ? 'bg-purple-100 text-purple-800' : 
                                         userRole.rol.nombreRol.contains('SUPERVISOR') ? 'bg-blue-100 text-blue-800' : 
                                         userRole.rol.nombreRol.contains('OPERADOR') ? 'bg-green-100 text-green-800' : 
                                         userRole.rol.nombreRol == 'VENDEDOR' ? 'bg-yellow-100 text-yellow-800' : 
                                         userRole.rol.nombreRol == 'ALMACENERO' ? 'bg-orange-100 text-orange-800' : 
                                         userRole.rol.nombreRol == 'CONTADOR' ? 'bg-indigo-100 text-indigo-800' : 
                                         'bg-gray-100 text-gray-800'}"
                          th:text="${userRole.rol.nombreRol}"
                        >
                          ADMINISTRADOR
                        </span>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <span
                        class="px-3 py-1 text-xs font-medium rounded-full"
                        th:classappend="${usuario.estado.name() == 'Activo' ? 'bg-green-100 text-green-800' : 
                                       usuario.estado.name() == 'Inactivo' ? 'bg-amber-100 text-amber-800' : 
                                       'bg-red-100 text-red-800'}"
                        th:text="${usuario.estado}"
                      >
                        Activo
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <p
                        class="text-sm text-gray-500"
                        th:text="${#temporals.format(usuario.fechaRegistro, 'dd/MM/yyyy HH:mm')}"
                      >
                        01/01/2024 12:00
                      </p>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex items-center justify-center gap-2">
                        <a
                          th:href="@{/admin/usuarios/editar/{id}(id=${usuario.idUsuario})}"
                          class="p-2 text-blue-600 hover:bg-blue-50 rounded-xl transition-colors duration-200"
                          title="Editar"
                        >
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="1.5"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                            />
                          </svg>
                        </a>

                        <!-- Dropdown para cambiar estado -->
                        <div
                          class="relative"
                          th:if="${usuario.email != 'admin@gmail.com'}"
                        >
                          <button
                            class="p-2 text-gray-600 hover:bg-gray-50 rounded-xl transition-colors duration-200"
                            onclick="toggleDropdown(this)"
                            title="Cambiar Estado"
                          >
                            <svg
                              class="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                              />
                            </svg>
                          </button>
                          <div
                            class="absolute right-0 mt-2 w-48 bg-white rounded-2xl shadow-lg border border-gray-200 py-2 z-10 hidden"
                          >
                            <a
                              th:href="@{/admin/usuarios/cambiar-estado/{id}(id=${usuario.idUsuario}, nuevoEstado='Activo')}"
                              class="block px-4 py-2 text-sm text-green-700 hover:bg-green-50 transition-colors duration-200"
                            >
                              Activar
                            </a>
                            <a
                              th:href="@{/admin/usuarios/cambiar-estado/{id}(id=${usuario.idUsuario}, nuevoEstado='Inactivo')}"
                              class="block px-4 py-2 text-sm text-amber-700 hover:bg-amber-50 transition-colors duration-200"
                            >
                              Desactivar
                            </a>
                            <a
                              th:href="@{/admin/usuarios/cambiar-estado/{id}(id=${usuario.idUsuario}, nuevoEstado='Bloqueado')}"
                              class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors duration-200"
                            >
                              Bloquear
                            </a>
                          </div>
                        </div>

                        <a
                          th:href="@{/admin/usuarios/eliminar/{id}(id=${usuario.idUsuario})}"
                          th:if="${usuario.email != 'admin@gmail.com'}"
                          class="p-2 text-red-600 hover:bg-red-50 rounded-xl transition-colors duration-200"
                          title="Eliminar"
                          onclick="return confirm('¿Estás seguro de que quieres eliminar este usuario?')"
                        >
                          <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="1.5"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                            />
                          </svg>
                        </a>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Mensaje cuando no hay usuarios -->
            <div th:if="${usuarios.empty}" class="text-center py-12">
              <div
                class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-6"
              >
                <svg
                  class="w-8 h-8 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                  />
                </svg>
              </div>
              <p class="text-lg font-medium text-gray-500 mb-2">
                No hay usuarios registrados
              </p>
              <p class="text-sm text-gray-400">
                Comienza creando el primer usuario del sistema
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Script para el mensaje de error -->
      <script th:if="${error}">
        document.addEventListener("DOMContentLoaded", function () {
          const mensaje = document.getElementById("mensajeError");
          setTimeout(() => {
            mensaje.classList.remove("opacity-0", "translate-y-4");
            mensaje.classList.add("opacity-100", "translate-y-0");
          }, 100);

          setTimeout(() => {
            mensaje.classList.remove("opacity-100", "translate-y-0");
            mensaje.classList.add("opacity-0", "translate-y-4");
            setTimeout(() => {
              mensaje.remove();
            }, 1000);
          }, 5000);
        });
      </script>

      <!-- Script para el mensaje de éxito -->
      <script th:if="${success}">
        document.addEventListener("DOMContentLoaded", function () {
          const mensaje = document.getElementById("mensajeSuccess");
          setTimeout(() => {
            mensaje.classList.remove("opacity-0", "translate-y-4");
            mensaje.classList.add("opacity-100", "translate-y-0");
          }, 100);

          setTimeout(() => {
            mensaje.classList.remove("opacity-100", "translate-y-0");
            mensaje.classList.add("opacity-0", "translate-y-4");
            setTimeout(() => {
              mensaje.remove();
            }, 1000);
          }, 5000);
        });
      </script>

      <!-- Script para dropdown -->
      <script>
        function toggleDropdown(button) {
          const dropdown = button.nextElementSibling;
          const isVisible = !dropdown.classList.contains("hidden");

          // Cerrar todos los dropdowns
          document.querySelectorAll(".absolute").forEach((d) => {
            d.classList.add("hidden");
          });

          if (!isVisible) {
            dropdown.classList.remove("hidden");
          }
        }

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".relative")) {
            document.querySelectorAll(".absolute").forEach((d) => {
              d.classList.add("hidden");
            });
          }
        });
      </script>
    </section>
  </body>
</html>
